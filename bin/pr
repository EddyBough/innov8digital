#!/usr/bin/env bash
set -euo pipefail
if ! git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  git push -u origin HEAD
fi
TITLE="$(git log -1 --pretty=%s || echo 'PR')"
BODY="$(git log -1 --pretty=%b || true)"
BRANCH="$(git branch --show-current)"
DEFAULT_BASE="$(git remote show origin | awk -F': ' '/HEAD branch/ {print $2}')"
BASE="${DEFAULT_BASE:-main}"
ISSUE_ID="$(echo "$BRANCH" | sed -n 's/^issue-\([0-9]\+\)-.*/\1/p')"
if [[ -n "${ISSUE_ID}" ]]; then
  BODY="$(printf "%s\n\nRelates to #%s" "${BODY:-}" "${ISSUE_ID}")"
fi
LABELS="ready,automerge"
gh pr create --fill --title "${TITLE}" --body "${BODY:-}" --base "${BASE}" --label "${LABELS}"
gh pr merge --auto --squash || true
gh pr status
